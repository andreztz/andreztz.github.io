<!doctype html><html><head><title>Protegendo o acesso a interface web do Openwrt - André Santos</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="André P. Santos"><link rel="shortcut icon" type=image/x-icon href=https://andreztz.github.io/img/favicon.ico><link rel=stylesheet href=https://andreztz.github.io/style.min.39acacc5d2051426f655a6b7fbf4786fbd0fd8fffd09322c9b497ef0f7439b3f.css integrity="sha256-OaysxdIFFCb2Vaa3+/R4b70P2P/9CTIsm0l+8PdDmz8="><link rel=stylesheet href=https://andreztz.github.io/style-dark.min.0a647fb6c07e04b77b54fa0515d0a683d39ecdb251dba960fe1f966f7ff36fc2.css media="(prefers-color-scheme: dark)" integrity="sha256-CmR/tsB+BLd7VPoFFdCmg9OezbJR26lg/h+Wb3/zb8I="><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.8.1/css/all.css integrity=sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf crossorigin=anonymous><link rel=stylesheet href=https://andreztz.github.io/css/custom.css><link rel=stylesheet href=https://andreztz.github.io/css/syntax.css><meta property="og:title" content="Protegendo o acesso a interface web do Openwrt"><meta property="og:description" content="Protegendo o acesso a interface web do openwrt O Openwrt pode ser gerenciado no terminal via ssh, ou pela interface web do usuário LuCI. O uso da interface web facilita a administração do sistema, no entanto, por padrão a interface web não tem suporte a conexão segura usando o HTTPS. Por esse motivo existe o risco de um invasor capturar o trafego de rede e obter as credenciais de autenticação, visto que a troca de mensagens entre cliente e servidor sem a camada de segurança do HTTPS (SSL/TLS) é feito em texto puro."><meta property="og:type" content="article"><meta property="og:url" content="https://andreztz.github.io/blog/posts/openwrt-interface-web-seguranca/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-04-05T03:49:21-03:00"><meta property="article:modified_time" content="2022-04-05T03:49:21-03:00"><meta itemprop=name content="Protegendo o acesso a interface web do Openwrt"><meta itemprop=description content="Protegendo o acesso a interface web do openwrt O Openwrt pode ser gerenciado no terminal via ssh, ou pela interface web do usuário LuCI. O uso da interface web facilita a administração do sistema, no entanto, por padrão a interface web não tem suporte a conexão segura usando o HTTPS. Por esse motivo existe o risco de um invasor capturar o trafego de rede e obter as credenciais de autenticação, visto que a troca de mensagens entre cliente e servidor sem a camada de segurança do HTTPS (SSL/TLS) é feito em texto puro."><meta itemprop=datePublished content="2022-04-05T03:49:21-03:00"><meta itemprop=dateModified content="2022-04-05T03:49:21-03:00"><meta itemprop=wordCount content="855"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:image content="https://andreztz.github.io//img/avatar.jpg"><meta name=twitter:title content="Protegendo o acesso a interface web do Openwrt"><meta name=twitter:description content="Protegendo o acesso a interface web do openwrt O Openwrt pode ser gerenciado no terminal via ssh, ou pela interface web do usuário LuCI. O uso da interface web facilita a administração do sistema, no entanto, por padrão a interface web não tem suporte a conexão segura usando o HTTPS. Por esse motivo existe o risco de um invasor capturar o trafego de rede e obter as credenciais de autenticação, visto que a troca de mensagens entre cliente e servidor sem a camada de segurança do HTTPS (SSL/TLS) é feito em texto puro."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-N2DNZ49Z76","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><h1>Protegendo o acesso a interface web do Openwrt</h1><header><div class=avatar><img class=avatarMask src=https://andreztz.github.io//img/avatar.jpg alt>
<a href=https://andreztz.github.io/><img class=avatar-border src=https://andreztz.github.io//img/avatar-border.svg alt></a></div><h2><a class=author href=https://andreztz.github.io/>André P. Santos</a></h2></header><p class=date>4 April, 2022</p><div id=contentBody><h1 id=protegendo-o-acesso-a-interface-web-do-openwrt>Protegendo o acesso a interface web do openwrt</h1><p>O Openwrt pode ser gerenciado no terminal via ssh, ou pela interface web do usuário <a href=https://openwrt.org/docs/guide-user/luci/start>LuCI</a>. O uso da interface web facilita a administração do sistema, no entanto, por padrão a interface web não tem suporte a conexão segura usando o HTTPS. Por esse motivo existe o risco de um invasor capturar o trafego de rede e obter as credenciais de autenticação, visto que a troca de mensagens entre cliente e servidor sem a camada de segurança do HTTPS (SSL/TLS) é feito em texto puro.</p><p><img src=https://andreztz.github.io/images/openwrt_captura_de_credenciais.png alt="captura do trafefo http com wireshark"></p><p>O Openwrt oferece a opção de implementar o HTTPS, mas é preciso gerar e armazenar um certificado TLS autoassinado e requer a instalação de pacotes adicionais (luci-ssl e dependências). No caso de dispositivos com pouca memoria, instalar pacotes adicionais não é uma opção, então gostaria de apresentar outra configuração que pode ser usada para proteger o acesso à interface web do Openwrt, que é <strong>encapsular o tráfego http via ssh</strong>.</p><p>Primeiro vamos fazer uma cópia e olhar o arquivo de configuração padrão do servidor web.</p><pre tabindex=0><code>$ scp openwrt:/etc/config/uhttpd ~
uhttpd                                                       100%  710   458.3KB/s   00:00 
</code></pre><pre tabindex=0><code>$ head ~/uhttpd 
# Server configuration
config uhttpd main

	# HTTP listen addresses, multiple allowed
	list listen_http	0.0.0.0:80
	list listen_http	[::]:80

	# HTTPS listen addresses, multiple allowed
	list listen_https	0.0.0.0:443
	list listen_https	[::]:443
</code></pre><p>Usando o comando <code>netstat -apn | grep :80</code> listamos os soquetes TCP/IP abertos pelo servidor web.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash-session data-lang=bash-session><span class=line><span class=cl><span class=go>root@openwrt:~# netstat -apn | grep :80
</span></span></span><span class=line><span class=cl><span class=go>tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      
</span></span></span><span class=line><span class=cl><span class=go>tcp        0      0 :::80                   :::*                    LISTEN
</span></span></span><span class=line><span class=cl><span class=go>root@openwrt:~# netstat -ana | grep :443
</span></span></span><span class=line><span class=cl><span class=go>root@openwrt:~# 
</span></span></span></code></pre></div><p>A linha <code>0.0.0.0:80</code> nos diz que o computador local esta ouvindo a porta 80, a espera de conexões de qualquer computador remoto. O <code>0.0.0.0</code> é um endereço especial que representa todas as interfaces de rede com um IP válido nesse host, por exemplo, poderiamos ter duas interfaces com os seguintes endereços <code>192.168.1.1</code>, <code>172.17.0.2</code> como o servidor web escuta usando o endereço <code>0.0.0.0:80</code> ambos respondem por esse endereço de socket.</p><p>Agora a configuração do servidor web uHTTPd deve ser ajustada, para fazer isso conectamos ao roteador via SSH e abrimos o arquivo <code>/etc/config/uhttpd</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># vim /etc/config/uhttpd</span>
</span></span></code></pre></div><p>Em seguida, comentamos as linhas que contêm <code>list listen_http *</code> e adicionamos a linha <code>list listen_http 127.0.0.1:80</code> . A seguir temos as primeiras linhas do arquivo de configuração após a edição.</p><pre tabindex=0><code># Server configuration
config uhttpd main

	# HTTP listen addresses, multiple allowed
	# list listen_http	0.0.0.0:80 # esta linha deve estar comentada
	# list listen_http	[::]:80 # esta linha deve estar comentada

	# HTTPS listen addresses, multiple allowed
	# list listen_https	0.0.0.0:443 # esta linha deve estar comentada
	# list listen_https	[::]:443  # esta linha deve estar comentada

    # linha adicionada
    list listen_http        127.0.0.1:80
	
    ...
</code></pre><p>Salve o arquivo e reinicie o serviço uHTTPd usando o comando:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># /etc/init.d/uhttpd restart</span>
</span></span></code></pre></div><p>Com o comando <code>netstat</code> vemos que agora nosso servidor web escuta em um novo endereço:</p><pre tabindex=0><code>root@openwrt:~# netstat -na | grep :80
tcp        0      0 127.0.0.1:80            0.0.0.0:*               LISTEN   
</code></pre><p>O uso do endereço <code>127.0.0.1</code> tem objetivo de restringir o acesso a interface web para host remotos usando a interface de loopback, que é uma interface de rede virtual que é reservada para a comunicação interna no host.</p><p>Depois de reiniciar o servidor, a interface web do LuCI não esta acessível através do IP usual <code>192.168.1.1</code>, agora o servidor web escuta por novas conexões usando o endereço <code>127.0.0.1:80</code> e só podemos alcançá-la por meio de um túnel ssh.</p><p>Para criar o túnel, execute o seguinte comando no terminal:</p><p>veja: <a href=https://stackoverflow.com/questions/20778771/what-is-the-difference-between-0-0-0-0-127-0-0-1-and-localhost>127.0.0.1 vs 0.0.0.0</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ssh -L 127.0.0.1:8080:127.0.0.1:80 root@192.168.1.1</span>
</span></span></code></pre></div><p>veja:
<a href=https://man.archlinux.org/man/ssh.1#L~4>manual ssh -L</a>
<a href=https://wiki.archlinux.org/title/OpenSSH#Forwarding_other_ports>Encaminhamento de portas</a></p><p>Para evitar sempre digitar todo o comando que cria o túnel ssh adicione ao arquivo <code>~/.ssh/config</code> o seguite:</p><pre tabindex=0><code>Host luci-tunnel
	Hostname openwrt.lan
	Port 22
	User root
	LocalForward 127.0.0.1:8080 127.0.0.1:80
</code></pre><p>Então o tunel ssh pode ser criado com o seguinte comando:</p><pre tabindex=0><code class=language-ssh data-lang=ssh># ssh luci-tunnel
</code></pre><p>O endereço local <code>127.0.0.1:8080</code> da máquina cliente é ligado através do túnel ssh ao endereço <code>127.0.0.1:80</code> do openwrt, onde o servidor web uHTTPd está aguardando solicitações. Agora é possivel abrir o endereço <a href=http://127.0.0.1>http://127.0.0.1:8080</a> no navegador e todo a comunicação HTTP com o servidor web é encapsulada no túnel SSH. Com isso todo o tráfico HTTP tem o mesmo nível de encriptação de uma sessão SSH. Enquanto a sessão SSH estiver aberta, será possível acessar a interface web usando um cliente HTTP. No terminal a combinação de teclas <code>ctrl+c</code> encerra a sessão SSH e a interface web do LuCI fica indisponivel.</p><p>Na minha opinião essa configuração não é mais complexa do que instalar o pacote luci-ssl e depois gerar um certificado TLS (autoassinado), e é a configuração ideal para dispositivos com pouca memória.</p><h2 id=segurança-adicional>Segurança adicional</h2><p>Para minizar os riscos de acesso não autorizado através da interface web, ative o servidor web via ssh somente quando necessário.</p><pre tabindex=0><code>/etc/init.d/uhttpd disable
/etc/init.d/uhttpd stop
</code></pre><h2 id=uci-comandos>uci comandos</h2><p>O <a href=https://openwrt.org/docs/guide-user/base-system/uci>uci</a> pode ajustar a configuração do uhttpd sem usar um editor de texto, no terminal digite as linhas a seguir:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># uci -q delete uhttpd.main.listen_http</span>
</span></span><span class=line><span class=cl><span class=c1># uci add_list uhttpd.main.listen_http=&#34;127.0.0.1:80&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># uci add_list uhttpd.main.listen_http=&#34;[::1]:80&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># uci -q delete uhttpd.main.listen_https</span>
</span></span><span class=line><span class=cl><span class=c1># uci add_list uhttpd.main.listen_https=&#34;127.0.0.1:443&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># uci add_list uhttpd.main.listen_https=&#34;[::1]:443&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># uci commit uhttpd</span>
</span></span><span class=line><span class=cl><span class=c1># /etc/init.d/uhttpd restart</span>
</span></span></code></pre></div></div><footer><p>&copy; 2022 André P. Santos.
Powered by <a href=https://gohugo.io/>Hugo</a>
using the <a href=https://github.com/koirand/pulp/>pulp</a> theme.</p></footer></body></html>